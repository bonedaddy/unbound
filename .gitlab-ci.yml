
buildx:
  image: docker:stable-git
  stage: .pre
  services:
    - docker:dind
  variables:
    GIT_STRATEGY: none
  before_script: []
  script:
    - export DOCKER_BUILDKIT=1
    - git clone git://github.com/docker/buildx /tmp/buildx
    - docker build --platform=local -o . /tmp/buildx
  artifacts:
    paths:
      - buildx
    expire_in: 1 hour

before_script:
  - mkdir -p ~/.docker/cli-plugins
  - mv buildx ~/.docker/cli-plugins/docker-buildx
  - apk add --no-cache curl git py-pip python-dev libffi-dev openssl-dev gcc libc-dev make
  - pip install docker-compose

.build:
  image: docker:latest
  stage: build
  services:
    - docker:dind
  script:
    - make buildx EXTRA_OPTS="--pull --load --platform=${PLATFORM}"

.test:
  image: docker:latest
  stage: test
  services:
    - docker:dind
  script:
    - make buildx test EXTRA_OPTS="--pull --load --platform=${PLATFORM}"

gitlab:
  image: docker:latest
  stage: deploy
  services:
    - docker:dind
  script:
    - echo "${CI_REGISTRY_PASSWORD}" | docker login -u "${CI_REGISTRY_USER}" --password-stdin "${CI_REGISTRY}"
    - make buildx IMAGE="${CI_REGISTRY_IMAGE}" EXTRA_OPTS="--pull --push --platform=linux/amd64,linux/arm64,linux/ppc64le,linux/s390x,linux/arm/v7,linux/arm/v6"
  only:
    - master

linux/amd64:
  extends: .test
  variables:
    PLATFORM: linux/amd64

linux/arm64:
  extends: .test
  variables:
    PLATFORM: linux/arm64

linux/ppc64le:
  extends: .test
  variables:
    PLATFORM: linux/ppc64le

linux/s390x:
  extends: .test
  variables:
    PLATFORM: linux/s390x

linux/arm/v7:
  extends: .test
  variables:
    PLATFORM: linux/arm/v7

linux/arm/v6:
  extends: .test
  variables:
    PLATFORM: linux/arm/v6

dockerhub:
  extends: gitlab
  variables:
    CI_REGISTRY: docker.io
    CI_REGISTRY_IMAGE: docker.io/${DOCKERHUB_REPOSITORY}
    CI_REGISTRY_USER: ${DOCKERHUB_USERNAME}
    CI_REGISTRY_PASSWORD: ${DOCKERHUB_PASSWORD}
  after_script:
    - docker run -v ${PWD}:/workspace -e DOCKERHUB_USERNAME -e DOCKERHUB_PASSWORD -e DOCKERHUB_REPOSITORY -e README_FILEPATH=/workspace/README.md peterevans/dockerhub-description
